<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
    --primary: #3a6ea5;
    --secondary: #1e4e79;
    --success: #4bb543;
    --danger: #d64545;
    --bg: #eef2f5;
    --card: #ffffff;
    --text: #222831;
}
* { margin: 0; padding: 0; box-sizing: border-box; font-family: "Montserrat", sans-serif; }
body {
    background: var(--bg);
    color: var(--text);
    padding: 2rem;
    display: flex;
    justify-content: center;
}
.container {
    width: 100%;
    max-width: 1200px;
}
.card {
    background: var(--card);
    border-radius: 16px;
    padding: 1.75rem;
    box-shadow: 0 4px 18px rgba(0,0,0,0.06);
    margin-bottom: 2rem;
}
h1 {
    font-size: 2.2rem;
    font-weight: 600;
    color: var(--primary);
}
button {
    cursor: pointer;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 0.75rem 1.5rem;
    font-size: 0.9rem;
    transition: 0.2s ease;
}
button:hover { background: var(--secondary); transform: translateY(-1px); }
button.small { padding: 0.55rem 1rem; font-size: 0.75rem; }
button.danger { background: var(--danger); }
button.danger:hover { filter: brightness(0.9); }
#studentsGrid {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
}
.student {
    background: var(--card);
    border-radius: 16px;
    padding: 1.2rem;
    box-shadow: 0 3px 14px rgba(0,0,0,0.05);
}
.status-dot {
    display: inline-block;
    width: 9px;
    height: 9px;
    border-radius: 50%;
    margin-right: 6px;
}
.active { background: var(--success); }
.inactive { background: var(--danger); }
input, select {
    padding: 0.7rem;
    border-radius: 10px;
    border: 1px solid #ccc;
    width: 100%;
    font-size: 0.9rem;
    margin-top: 0.4rem;
}
.modal {
    position: fixed;
    top: 4%;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    height: 90%;
    background: var(--card);
    border-radius: 18px;
    box-shadow: 0 4px 25px rgba(0,0,0,0.25);
    padding: 1rem;
    display: none;
    flex-direction: column;
    z-index: 9999;
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
img.liveView {
    width: 100%;
    height: 100%;
    object-fit: contain;
}
#historyPanel ul { list-style: none; margin-top: 0.5rem; }
#historyPanel li { padding: 0.4rem 0; font-size: 0.9rem; }
</style>
</head>

<body>
<div class="container">
    <div class="card" id="loginCard">
        <h1>Teacher Login</h1>
        <input id="emailInput" type="email" placeholder="Email">
        <input id="passwordInput" style="margin-top:10px" type="password" placeholder="Password">
        <button id="loginBtn" style="margin-top:12px">Login</button>
    </div>

    <div id="dashboard" style="display:none">
        <div class="card">
            <h1 id="teacherHeader"></h1>
            <button id="logoutBtn">Logout</button>
        </div>

        <div class="card">
            <h2>Allowed Sites</h2>
            <input id="allowedInput" type="text" placeholder="example.com">
            <button id="addAllowed">Add</button>
            <ul id="allowList" style="margin-top: 1rem;"></ul>
        </div>

        <div class="card">
            <h2>Students</h2>
            <div id="studentsGrid"></div>
        </div>

        <div id="historyPanel" class="card"></div>
    </div>
</div>

<div id="liveModal" class="modal">
    <div class="modal-header">
        <h3 id="liveTitle"></h3>
        <button id="closeLive">Close</button>
    </div>
    <img id="liveImage" class="liveView">
</div>

<script>
const serverUrl = "https://sentinel.ayaangrover.hackclub.app";
let token = null;
let userInfo = null;

async function api(path, method="GET", body=null) {
    const headers = { "Authorization": "Bearer " + token };
    if (body) headers["Content-Type"] = "application/json";
    const res = await fetch(serverUrl + path, { method, headers, body: body ? JSON.stringify(body) : undefined });
    if (res.status === 401) return logout();
    return res.json();
}

async function login() {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    const res = await fetch(serverUrl + "/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
    });
    if (!res.ok) return;
    const data = await res.json();
    token = data.token;
    userInfo = data.user;
    showDashboard();
}

function logout() {
    token = null;
    userInfo = null;
    loginCard.style.display = "block";
    dashboard.style.display = "none";
}

function showDashboard() {
    loginCard.style.display = "none";
    dashboard.style.display = "block";
    teacherHeader.textContent = "Welcome, " + userInfo.email;
    refreshRules();
    refreshStudents();
}

async function refreshRules() {
    const rules = await api("/rules");
    allowList.innerHTML = "";
    rules.forEach(r => {
        const li = document.createElement("li");
        li.textContent = r.condition.url;
        const btn = document.createElement("button");
        btn.textContent = "X";
        btn.onclick = async () => {
            const updated = rules.filter(x => x.id !== r.id);
            await api("/rules","POST",{rules:updated});
            refreshRules();
        };
        li.appendChild(btn);
        allowList.appendChild(li);
    });
}

addAllowed.onclick = async () => {
    const url = allowedInput.value.trim();
    if (!url) return;
    const rules = await api("/rules");
    rules.push({ id: Date.now(), condition:{url}, action:{} });
    await api("/rules","POST",{rules});
    allowedInput.value = "";
    refreshRules();
};

async function refreshStudents() {
    const data = await api("/students");
    studentsGrid.innerHTML = "";
    data.forEach(st => {
        const div = document.createElement("div");
        div.className="student";
        const status = Date.now()-new Date(st.lastActivity).getTime()<15000;
        div.innerHTML = `
            <b>${st.userId}</b>
            <br>
            <span class="status-dot ${status?"active":"inactive"}"></span>
            ${status?"Active":"Inactive"}
            <br><br>
            <button class="small" onclick="viewHistory('${st.userId}')">History</button>
            <button class="small" onclick="livePreview('${st.userId}')">Live</button>
        `;
        studentsGrid.appendChild(div);
    });
}

async function viewHistory(id) {
    const hist = await api("/history?userId="+id);
    historyPanel.innerHTML = "<h2>History: "+id+"</h2><ul>" + hist.map(h => {
        const t = new Date(h.timestamp).toLocaleTimeString();
        return `<li><b>${t}</b> ${h.tabVisited || ""}</li>`;
    }).join("") + "</ul>";
}

async function livePreview(id) {
    liveTitle.textContent = id;
    liveModal.style.display="flex";
    const upd = async () => {
        const d = await api("/capture/latest?userId="+id);
        if (d && d.hasImage) {
            liveImage.src = serverUrl+"/capture/latest?userId="+id;
        }
    };
    upd();
    liveModal.interval=setInterval(upd,1000);
}

closeLive.onclick = () => {
    clearInterval(liveModal.interval);
    liveModal.style.display="none";
};

loginBtn.onclick = login;
logoutBtn.onclick = logout;
setInterval(() => { if(token) refreshStudents(); },10000);
</script>

</body>
</html>